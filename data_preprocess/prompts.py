ROLE_TAG_PROMPT_V2 = r"""
你是“原神攻略文本信息抽取器”。给定【角色攻略文本】，你需要抽取该角色的定位标签（RoleTag）。
你必须严格使用我提供的 RoleTag 词表，不得发明新标签。
输出必须是严格 JSON（不要 Markdown、不要额外字段），必须符合给定 schema。

【重要原则：不要硬凑标签】
- 文本描述的能力如果无法明确映射到词表中的某个 RoleTag，请不要输出该标签（宁缺毋滥）。
- evidence 必须是原文最小证据片段（10~40字），且必须包含触发该 role 的关键词。

【RoleTag 词表（只能用这些 id）】
- role_main_dps：主C / 站场主C / 主输出
- role_burst_dps：爆发C / 速切输出
- role_sub_dps：副C / 后台副C / 脱手C / 副输出 / 后台输出
- role_buffer：增伤辅助 / 拐 / 增益（必须是“对队友的增伤/加攻/加暴击/加伤害”等）
- role_debuffer：减抗辅助 / 减防 / 减抗
- role_healer：治疗 / 奶 / 回复
- role_shielder：护盾 / 盾
- role_survivability：生存位（泛指治疗或护盾；仅在未明确治疗/护盾时使用）
- role_cc：聚怪 / 控场
- role_driver：驾驶员 / 站场驾驶员（站场触发后台协同）
- role_energy_support：充能辅助 / 充电宝 / 回能
- role_enabler_pyro：挂火 / 火底 / 施火
- role_enabler_hydro：挂水 / 水底 / 施水
- role_enabler_electro：挂雷 / 雷底 / 施雷
- role_enabler_cryo：挂冰 / 冰底 / 施冰
- role_enabler_dendro：挂草 / 草底 / 施草
- role_reaction_trigger：反应触发 / 反应C（以反应伤害为核心）

【硬触发词规则（必须遵守）】
A. role_healer（治疗）：
- evidence 必须包含：治疗/回复/回血/奶/恢复生命值
- 如果满足 role_healer，不得仅因“辅助”一词输出 role_buffer

B. role_shielder（护盾）：
- evidence 必须包含：护盾/盾/护盾值/开盾/套盾
- 仅“抗打断/霸体/减伤”不等于护盾（除非原文明确护盾）

C. role_buffer（增伤辅助）：
- evidence 必须包含对队友/全队的增益关键词之一：
  增伤/提升伤害/伤害加成/加攻/攻击力提升/暴击率/暴击伤害/元素伤害加成/精通提升/增益
- 仅出现：治疗/护盾/生存/辅助（泛词） -> 不得判为 role_buffer

D. role_debuffer（减抗/减防）：
- evidence 必须包含：减抗/降低抗性/减防/降低防御/破防/易伤

E. role_energy_support（充能辅助）：
- evidence 必须包含：充能/回能/元素能量/产球/元素微粒/电池/充电宝/降低充能压力/西风/祭礼
- 禁止将：跳跃高度/次数/位移/机动性/手感顺畅 等“非能量信息”推断为充能辅助

F. role_enabler_*（挂元素）：
- evidence 必须包含：挂X/施加X/附着X/稳定挂X/持续挂X/后台挂X/高频挂X（X为对应元素）
- 仅“该角色是X元素”不等于挂X位

G. role_reaction_trigger（反应触发）：
- 仅当 evidence 明确“反应伤害为核心”才输出，证据需包含至少一个强信号：
  超绽放/烈绽放/绽放/感电/超载/燃烧/扩散伤害为主/反应伤害为主/精通流/堆精通打反应
- 仅“配合反应/能打反应/吃反应”不得输出此标签

H. role_main_dps / role_burst_dps / role_sub_dps / role_driver（输出形态与站场）：
- role_main_dps：evidence 必须包含：站场/持续输出/主输出/打满场上时间/普攻输出
- role_burst_dps：evidence 必须包含：速切/爆发/开Q一套/短轴/一轮输出
- role_sub_dps：evidence 必须包含：后台/脱手/离场/协同攻击/后台输出
- role_driver：evidence 必须包含：驾驶员/站场触发后台/普攻驱动/触发协同

【互斥与优先级规则（必须遵守）】
1) 如果已输出 role_healer 或 role_shielder，则不要再输出 role_survivability；
   只有当文本只说“生存位/提高容错”但未明确治疗或护盾时，才输出 role_survivability。
2) 同时命中 main/burst/sub 时，优先选择“证据更明确、站场时间描述更强”的一个；
   只有当文本明确“既可站场也可后台/两种玩法”时，才允许输出多个，并降低其中一个 confidence。

【条件性降置信度规则（必须遵守）】
- 若 evidence 中出现：X命/满命/高命座/特定武器/特定队伍/高练度/竞速/整活 等条件词，
  则该标签 confidence 上限为 0.70，并在 reasoning_hint 中明确写出条件（例如“仅在6命时可…”）。

【confidence 标定建议】
- 明确定位句式（“定位为…/属于…位”）：0.85~0.95
- 明确功能句式（“提供全队治疗/稳定后台输出/稳定挂水/减抗”）：0.75~0.90
- 条件性成立：在对应范围基础上 -0.15~-0.30（且上限0.70）
- 弱表述（“可作为/也可以/可考虑”）：0.55~0.70（低于0.60则不要输出）

【输出过滤】
- 仅输出 confidence >= 0.60 的 role_tags
- 每个 role_id 最多输出 1 条
- role_tags 按 confidence 降序排列
- 如果文本没有出现目标角色，请输出 items: []

【输出 JSON schema】
{
  "items": [
    {
      "character_name": "角色名（原文出现的写法）",
      "role_tags": [
        {
          "role_id": "必须来自词表",
          "confidence": 0.0,
          "evidence": "原文证据片段",
          "reasoning_hint": "一句话说明为何该证据触发该 role（如有条件必须写明）"
        }
      ]
    }
  ]
}
"""

MONSTER_PROMPT_V3 = r"""你是“原神攻略关系抽取器”。请从输入攻略文本中抽取【角色】对【指定怪物】的关系，只输出 JSON。
输入：
monster: <怪物名>
strategy: <攻略文本>
role_dict（JSON 数组，subject 必须完全等于其中某一项）：['凝光', '艾尔海森', '娜维娅', '鹿野院平藏', '宵宫', '五郎', '千织', '风主', '可莉', '纳西妲', '爱诺', '白术', '班尼特', '魈', '雷泽', '琳妮特', '埃洛伊', '瑶瑶', '久岐忍', '芭芭拉', '赛索斯', '钟离', '水主', '珐露珊', '茜特菈莉', '梦见月瑞希', '岩主', '枫原万叶', '神里绫华', '安柏', '草主', '基尼奇', '雅珂达', '托马', '八重神子', '奇偶', '凯亚', '九条裟罗', '阿贝多', '迪希雅', '优菈', '菲谢尔', '流浪者', '北斗', '丝柯克', '神里绫人', '玛拉妮', '申鹤', '迪卢克', '阿蕾奇诺', '希诺宁', '迪奥娜', '伊法', '刻晴', '塔利雅', '欧洛伦', '杜林', '荒泷一斗', '坎蒂丝', '烟绯', '菈乌玛', '丽莎', '菲米尼', '米卡', '七七', '重云', '卡维', '多莉', '琴', '林尼', '砂糖', '莫娜', '胡桃', '赛诺', '早柚', '爱可菲', '夏沃蕾', '恰斯卡', '行秋', '甘雨', '夏洛蒂', '芙宁娜', '菲林斯', '嘉明', '伊涅芙', '雷电将军', '艾梅莉埃', '罗莎莉亚', '达达利亚', '奈芙尔', '绮良良', '提纳里', '柯莱', '希格雯', '那维莱特', '蓝砚', '瓦雷莎', '温迪', '香菱', '辛焱', '火主', '玛薇卡', '伊安珊', '莱依拉', '妮露', '雷主', '诺艾尔', '云堇', '卡齐娜', '闲云', '克洛琳德', '莱欧斯利', '珊瑚宫心海', '夜兰'}]

强约束规则:
1) subjects 必须是一个 数组，且每个元素都必须 精确匹配 role_dict 中的角色名（不允许别名/简称/改写/同义替换）,如果无法匹配角色，输出为空。
2) object 必须是怪物名。
3) 关系固定为"克制"，不要更改。
4) 不允许把“元素/机制/反应/状态/技能名”（如“雷盾”“吸能”“夜魂性质”“增伤”）当作 object。
5) 不允许使用常识补全：只依据给定文本与给定列表判断。
6) 合并规则：当同一段 evidence 同时提到多个角色，并且它们对同一个 object 关系相同，则输出为 一个结果，把这些角色全部放进 subjects 列表中；不要拆成多条。
7) 输出必须是合法 JSON，不得输出任何解释性文字或 markdown。
8) 置信度 confidence 0~1；不确定就不要输出该条。

输出（严格 JSON，禁止任何额外文字）：
{
  "subjects": ["<角色1>", "<角色2>"],
  "relation": "克制",
  "object": "<怪物名>",
  "evidence": "<原文证据片段>",
  "reasoning_hint": "<一句话说明为什么是该关系>",
  "confidence": 0.0
}
"""

C2C_PROMPT = r"""你是“原神角色-角色关系抽取器（中文严格版）”。我将输入两个角色（subject/object）以及【subject 角色】的中文语音文本 cn_text。你的任务是：只根据 cn_text 中的明确字面信息，抽取 subject 与 object 的关系，并输出严格合法 JSON。

输入字段：
subject: <主语角色>
object: <宾语角色>
cn_text: <subject 的语音文本>

========================
硬性总规则（必须遵守）
========================
A) 仅依据 cn_text 的【明确字面信息】抽取关系：必须能从 cn_text 中复制出【连续原文证据片段】作为 evidence。禁止基于常识/剧情背景/玩家知识推断。
B) 只输出“角色对角色”的【身份/社会关系】或【情感/态度关系】。关系必须能落到清晰语义：角色A — 关系 — 角色B，并且方向明确。
C) predicate 必须是【中文】且必须从【关系白名单】中选择；不得出现任何英文字母、数字、下划线、拼音、emoji。
D) 禁止输出无意义关系：不得输出仅为“是/称呼/叫作/喊/昵称/外号/称号/名字/身份是……”这类没有关系语义贡献的 predicate。
   - 尤其禁止 predicate 为“是”“称呼”“叫”“叫作”“喊”“名字”“外号”“昵称”“称号”“身份”“认识(若无对称明确)”“提到”等。
E) 主客体必须明确指向：evidence 中必须能明确表明关系是发生在 subject 与 object 之间（或 object 对 subject），不允许“可能/也许/听说/传闻/好像/据说”这类不确定表达。
F) 指代与省略：若证据中只出现“他/她/那家伙/这孩子/那位”等指代，而无法无歧义地确定就是 subject 或 object，则该关系不得输出。
G) 方向（direction）必须准确：
   - "subject_to_object"：文本明确表达 subject -> object 的关系
   - "object_to_subject"：文本明确表达 object -> subject 的关系
   - "symmetric"：文本明确表达对称关系（例如“朋友/同伴/队友/合作伙伴/相识/搭档”等）
   若无法确定方向或只有暧昧暗示：不要输出该关系。
H) 输出必须为【纯 JSON】：不得包含解释性文字、不得包含 markdown、不得包含多余字段。

========================
关系白名单（predicate 只能从这里选）
========================
1) 身份/社会关系（Role/Social）
- 亲属类：父亲, 母亲, 儿子, 女儿, 兄长, 弟弟, 姐姐, 妹妹, 祖父, 祖母, 亲人
- 师徒/教导：老师, 学生, 师父, 徒弟, 导师, 学徒
- 组织/职务：上司, 下属, 同事, 部下, 领袖, 副手
- 同行/同伴：朋友(对称), 同伴(对称), 队友(对称), 搭档(对称), 合作伙伴(对称), 相识(对称), 盟友(对称)
- 其他可落地身份：主人, 仆人, 雇主, 雇员, 客人

2) 情感/态度关系（Affect/Stance）
- 正向：感激, 信任, 尊敬, 敬仰, 崇拜, 喜爱, 依赖, 亲近, 保护, 照顾, 报恩
- 负向：厌恶, 憎恨, 敌视, 警惕, 怀疑, 轻视, 嫉妒, 羡慕, 害怕, 威胁, 复仇
- 强语义身份化情感词（允许）：恩人, 仇人

【对称关系强约束】
- 若 predicate 属于：朋友, 同伴, 队友, 搭档, 合作伙伴, 相识, 盟友
  则 direction 必须为 "symmetric"。
- 其他 predicate 一律不得使用 "symmetric"。

========================
禁止项细化（务必执行）
========================
1) 仅描述称谓/叫法，不等于关系：例如“我叫他XX”“大家都喊她XX”“人称XX”——全部禁止输出。
2) 单纯“是”句式不等于关系：例如“他是个好人/她是天才/他是骑士”——不属于“角色对角色关系”，禁止输出。
3) 仅出现关系名词但对象不明：例如“姐姐真麻烦”（没说姐姐是谁）——禁止输出。
4) 仅提到对方名字但无关系语义：例如“我见过他”“我听说过她”——除非明确为白名单中的“相识(对称)”并且证据能明确双方互相认识，否则禁止输出。

========================
证据（evidence）要求
========================
- evidence 必须从 cn_text 中复制【连续原文片段】（不改写、不拼接多段、不自己补字）。
- evidence 需要能够直接支撑 predicate 与 direction 的判断。

========================
置信度（confidence）标注规则
========================
- 0.90~1.00：证据中直接点明关系词且对象明确（如“X是我的老师”“我很感激Y”）
- 0.70~0.89：证据较明确但存在轻微语境依赖（仍需无歧义）
- <0.70：不要输出

========================
输出格式（严格 JSON，不得多字段）
========================
{
  "subject": "<subject>",
  "object": "<object>",
  "relations": [
    {
      "predicate": "<必须为白名单中文关系词>",
      "direction": "subject_to_object|object_to_subject|symmetric",
      "evidence": "<从 cn_text 复制的连续原文片段>",
      "reasoning_hint": "<一句中文短句，必须不含英文字母：例如 '丽莎 是 雷泽 的 老师' 或 '申鹤 感激 重云'>",
      "confidence": 0.0
    }
  ]
}

========================
额外规则
========================
- 若 cn_text 中没有任何可确定关系：relations 输出空数组 []（仍需输出完整 JSON 外壳）。
- 每条 relation 只描述一种关系；不要把多个关系揉成一句话。
- 同一关系若证据重复或语义相同，只输出置信度最高的一条。
- 最终输出中不得出现任何英文字母（A-Z / a-z）、下划线或拼音；一旦会出现，宁可不输出关系，保持 relations 为空。

现在开始：只输出 JSON。
"""



STRATEGY_PROMPT = r"""
你是“原神配队攻略信息抽取器”。请把输入攻略文本抽取成结构化 JSON，用于“给定核心角色→补全队友”。
输入：
core_character: "<给定角色>"
role_list（每个角色名必须完全等于其中一项）：['凝光', '艾尔海森', '娜维娅', '鹿野院平藏', '宵宫', '五郎', '千织', '风主', '可莉', '纳西妲', '爱诺', '白术', '班尼特', '魈', '雷泽', '琳妮特', '埃洛伊', '瑶瑶', '久岐忍', '芭芭拉', '赛索斯', '钟离', '水主', '珐露珊', '茜特菈莉', '梦见月瑞希', '岩主', '枫原万叶', '神里绫华', '安柏', '草主', '基尼奇', '雅珂达', '托马', '八重神子', '奇偶', '凯亚', '九条裟罗', '阿贝多', '迪希雅', '优菈', '菲谢尔', '流浪者', '北斗', '丝柯克', '神里绫人', '玛拉妮', '申鹤', '迪卢克', '阿蕾奇诺', '希诺宁', '迪奥娜', '伊法', '刻晴', '塔利雅', '欧洛伦', '杜林', '荒泷一斗', '坎蒂丝', '烟绯', '菈乌玛', '丽莎', '菲米尼', '米卡', '七七', '重云', '卡维', '多莉', '琴', '林尼', '砂糖', '莫娜', '胡桃', '赛诺', '早柚', '爱可菲', '夏沃蕾', '恰斯卡', '行秋', '甘雨', '夏洛蒂', '芙宁娜', '菲林斯', '嘉明', '伊涅芙', '雷电将军', '艾梅莉埃', '罗莎莉亚', '达达利亚', '奈芙尔', '绮良良', '提纳里', '柯莱', '希格雯', '那维莱特', '蓝砚', '瓦雷莎', '温迪', '香菱', '辛焱', '火主', '玛薇卡', '伊安珊', '莱依拉', '妮露', '雷主', '诺艾尔', '云堇', '卡齐娜', '闲云', '克洛琳德', '莱欧斯利', '珊瑚宫心海', '夜兰'}]

要求：
- 只输出 JSON（不要 markdown、不要解释）。
- 只抽文本中明确写到的内容，不要补常识。
- 每条关键信息尽量给 evidence（原文短片段，10~30字）。

输出格式（固定字段，不要新增字段）：
{
  "core_character": "<给定角色>",
  "archetypes": [
    {
      "name": "<队伍体系/流派名，如 激绽队/纯感电/砂糖武装队>",
      "focus": true/false,
      "core_role": "<如 驾驶员/站场/核心>",
      "core_evidence": "<短证据>",
      "slots": [
        {
          "slot": "<如 挂雷/挂水/挂草/增伤/减抗/治疗/护盾等>",
          "need": "<这一位需要提供什么：后台输出/高频挂元素/增伤/减伤抗打断/治疗/护盾等>",
          "must": true/false,
          "evidence": "<短证据>"
        }
      ],
      "candidates": [
        {
          "character": "<角色名>",
          "slot": "<挂雷/挂水/挂草等>",
          "role": "<后台输出/增伤辅助/生存辅助等>",
          "fit": "good|ok|avoid",
          "why": ["<原因1>", "<原因2>"],
          "evidence": ["<对应证据1>", "<对应证据2>"]
        }
      ],
      "example_team": {
        "members": ["<角色1>","<角色2>","<角色3>","<角色4>"],
        "evidence": "<短证据>"
      }
    }
  ]
}

抽取规则：
1) archetypes：看到“X队/体系/队伍”就记为一个 name；如果文末说“下面将围绕A,B,C,D组成的X队分析”，该 archetype 的 focus=true，且 example_team 填这4人。
2) slots：文本按“雷元素队友选择如下/水元素队友选择如下/草元素队友选择如下”这种小节时，分别生成 雷位/水位/草位 的 slot；need 写这一节对队友的总体要求（如“后台输出”“高频挂水”），能写就写，写不出就留空字符串。
3) candidates：每个候选角色生成一条；role 从“后台输出/增伤辅助/生存辅助/驾驶员”等短语抽；fit 若文本出现“不适合/缺乏竞争力/更偏向X而非Y/价值较低”则为 avoid；出现“主流/适合/优势/可论证”则为 good；其余 ok。
4) why：用简短中文概括（不要超过20字/条），并配对应 evidence。
"""


NOISE_RELATIONS = [
    '亲切稳重的大姐姐',
    '关系',
    '前任骑兵队长',
    '可能',
    '家乡',
    '水平差异',
    '混合物',
    '玩',
    '等候时机',
    '藏',
    '被',
]

RELATION_REWRITE_MAP = {
    '乐意帮助': '帮助',
    '交易对象': '交易伙伴',
    '亲切地邀请': '邀请',
    '信赖': '信任',
    '值得信赖': '信任',
    '减轻负担': '分担',
    '同行/同伴': '同伴',
    '小后辈': '后辈',
    '师傅': '师父',
    '帮助人追梦': '支持',
    '开玩笑': '打趣',
    '忠心可鉴': '忠于',
    '感激': '感谢',
    '提到': '提及',
    '朋友(对称)': '朋友',
    '生意伙伴': '交易伙伴',
    '相信': '信任',
    '相处不来': '难以打交道',
    '聊天对象': '交谈',
    '认 可': '认可',
    '送去': '赠送',
    '道不同不相为谋': '立场不同',
}